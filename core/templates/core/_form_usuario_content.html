{% comment %}
  Versión con el estilo del botón "Añadir otro email" corregido.
{% endcomment %}

<form id="form-usuario" action="{% url 'form_usuario' %}" method="post" novalidate>
    {% csrf_token %}
    <input type="hidden" name="usuario_id" value="{{ form.instance.pk|default:'' }}">

    <div class="section-container">
        <span class="badge text-white">DATOS DEL USUARIO</span>

        <div class="row mb-3 mt-3">
            <div class="col-md-6">
                <label for="id_username" class="form-label">Nombre de Usuario</label>
                {{ form.username }}
                {% if form.username.help_text %}<small class="form-text text-muted">{{ form.username.help_text }}</small>{% endif %}
                {% if form.username.errors %}<div class="invalid-feedback d-block">{{ form.username.errors.0 }}</div>{% endif %}
            </div>
            <div class="col-md-6">
                <label for="id_password" class="form-label">Contraseña</label>
                <div class="input-group">
                    {{ form.password }}
                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword()"><i class="bi bi-eye" id="toggleIcon"></i></button>
                </div>
                {% if form.instance.pk %}
                    <small class="form-text text-muted">{{ form.password.help_text }}</small>
                {% else %}
                    <small class="form-text text-muted">Establece una contraseña inicial para el nuevo usuario.</small>
                {% endif %}
                {% if form.password.errors %}<div class="invalid-feedback d-block">{{ form.password.errors.0 }}</div>{% endif %}
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label for="id_correo" class="form-label">Correo electrónico</label>
                {{ form.correo }}
                {% if form.correo.help_text %}<small class="form-text text-muted">{{ form.correo.help_text }}</small>{% endif %}
                {% if form.correo.errors %}<div class="invalid-feedback d-block">{{ form.correo.errors.0 }}</div>{% endif %}
            </div>
            <div class="col-md-6">
                <label for="id_telefono" class="form-label">Teléfono</label>
                {{ form.telefono }}
                {% if form.telefono.errors %}<div class="invalid-feedback d-block">{{ form.telefono.errors.0 }}</div>{% endif %}
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label for="id_rol" class="form-label">Rol</label>
                {{ form.rol }}
                {% if form.rol.help_text %}<small class="form-text text-muted">{{ form.rol.help_text }}</small>{% endif %}
                {% if form.rol.errors %}<div class="invalid-feedback d-block">{{ form.rol.errors.0 }}</div>{% endif %}
            </div>
            <div class="col-md-6">
                <label for="id_cliente" class="form-label">Razón Social Cliente</label>
                {{ form.cliente }}
                {% if form.cliente.help_text %}<small class="form-text text-muted">{{ form.cliente.help_text }}</small>{% endif %}
                {% if form.cliente.errors %}<div class="invalid-feedback d-block">{{ form.cliente.errors.0 }}</div>{% endif %}
            </div>
        </div>
    </div>

    <div class="section-container">
        <span class="badge ">EMAILS ADICIONALES (COPIA)</span>
        {{ email_formset.management_form }}
        <div id="email-formset-container" class="mt-3">
            {% for email_form in email_formset %}
                <div class="row align-items-center email-form mb-2">
                    <div class="col">
                        {{ email_form.id }}{{ email_form.email }}
                        {% if email_form.email.errors %}<div class="invalid-feedback d-block">{{ email_form.email.errors.0 }}</div>{% endif %}
                    </div>
                    {% if email_form.instance.pk %}
                    <div class="col-auto">
                        <label class="form-check">{{ email_form.DELETE }} <span class="form-check-label text-danger" style="font-size: 12px;">Eliminar</span></label>
                    </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
        
        <button type="button" id="add-email-form" class="btn btn-sm btn-outline-dark mt-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-plus" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 5l0 14" /><path d="M5 12l14 0" /></svg>
            Añadir otro email
        </button>

        <template id="empty-form-template">
            <div class="row align-items-center email-form mb-2">
                <div class="col">{{ email_formset.empty_form.id }}{{ email_formset.empty_form.email }}</div>
            </div>
        </template>
    </div>
</form>