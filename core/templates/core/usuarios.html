{% extends 'core/base.html' %}

{% block title %}Administración de Usuarios - Safe Your Cargo{% endblock %}

{% block content %}
<style>
  table thead th {
    background: #f0f2f5;
    font-size: .75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: .04em;
    line-height: 1rem;
    color: #6c7a91;
    padding-top: .5rem;
    padding-bottom: .5rem;
    white-space: nowrap;
    border-top-width: 1px;
    font-family: "Inter Var", Inter, -apple-system, BlinkMacSystemFont, "San Francisco", "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
  }
  td, th {
    font-size: 13px;
  }
</style>

<div class="page-wrapper">
  <div class="page-header d-print-none">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <div class="page-pretitle">Administración de</div>
          <h2 class="page-title">Usuarios</h2>
        </div>
        <div class="col-auto ms-auto d-print-none">
          <div class="btn-list">
            <a href="#" class="btn btn-primary d-none d-sm-inline-block" data-bs-toggle="modal" data-bs-target="#modal-usuario" style="background-color:#009925">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 5l0 14" /><path d="M5 12l14 0" />
              </svg>
              Nuevo Usuario
            </a>
            <a href="#" class="btn btn-primary d-sm-none btn-icon" data-bs-toggle="modal" data-bs-target="#modal-usuario" aria-label="Crear usuario">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 5l0 14" /><path d="M5 12l14 0" />
              </svg>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="page-body">
    <div class="container-xl">
      <div class="row row-deck row-cards">
        <div class="container mt-4" style="overflow-x: auto;">
          <table id="tabla-usuarios" class="table table-hover table-bordered align-middle text-nowrap">
            <thead>
              <tr>
                <th>ESTADO</th>
                <th>USERNAME</th>
                <th>ROL</th>
                <th>CLIENTE</th>
                {% if request.user.is_superuser or request.user.rol == "Administrador" %}
                <th>ACCIONES</th>
                {% endif %}
              </tr>
            </thead>
            <tbody>
              {% for usuario in usuarios %}
              <tr>
                <td>
                  <span class="badge {% if usuario.is_active %}bg-success{% else %}bg-danger{% endif %} estado-label">
                    {% if usuario.is_active %}Activo{% else %}Inactivo{% endif %}
                  </span>
                </td>
                <td>{{ usuario.username }}</td>
                <td>{{ usuario.rol }}</td>
                <td>{{ usuario.cliente.nombre|default:"N/A" }}</td>
                {% if request.user.is_superuser or request.user.rol == "Administrador" %}
<td>
  <button type="button" class="btn btn-outline-secondary btn-sm mt-1"
          data-bs-toggle="modal" 
          data-bs-target="#modal-usuario"
          data-id="{{ usuario.id }}">
    Editar
  </button>

  <button type="button"
          class="btn btn-outline-secondary btn-sm mt-1 toggle-estado-btn"
          data-id="{{ usuario.id }}">
    {% if usuario.is_active %}Desactivar{% else %}Activar{% endif %}
  </button>
  
  <button type="button" 
          class="btn btn-outline-danger btn-sm mt-1 eliminar-usuario" 
          data-id="{{ usuario.id }}">
    Eliminar
  </button>
</td>
                {% endif %}
              </tr>
              {% empty %}
              <tr>
                <td colspan="5" class="text-center text-muted">No hay usuarios registrados aún.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

{% include 'core/modal_crear_usuario.html' %}

<script>
// --- FUNCIONES AUXILIARES ---
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function togglePassword() {
  const input = document.getElementById("password");
  const icon = document.getElementById("toggleIcon");
  if (!input || !icon) return;
  if (input.type === "password") {
    input.type = "text";
    icon.classList.replace("bi-eye", "bi-eye-slash");
  } else {
    input.type = "password";
    icon.classList.replace("bi-eye-slash", "bi-eye");
  }
}

function initializeFormsetLogic() {
  const formContainer = document.querySelector('#form-usuario-container');
  if (!formContainer) return;

  formContainer.addEventListener('click', function(event) {
    // Busca el botón por su ID o una clase específica para evitar conflictos
    const addButton = event.target.closest('#add-email-form');
    if (addButton) {
      const formsetContainer = document.getElementById('email-formset-container');
      const totalFormsInput = document.getElementById('id_emails-TOTAL_FORMS');
      const emptyFormTemplate = document.getElementById('empty-form-template');
      if (!formsetContainer || !totalFormsInput || !emptyFormTemplate) return;

      const formIndex = parseInt(totalFormsInput.value);
      const newFormHtml = emptyFormTemplate.innerHTML.replace(/__prefix__/g, formIndex);
      formsetContainer.insertAdjacentHTML('beforeend', newFormHtml);
      totalFormsInput.value = formIndex + 1;
    }
  });
}


// --- LÓGICA PRINCIPAL ---
document.addEventListener("DOMContentLoaded", function () {
    const modalEl = document.getElementById('modal-usuario');
    const tabla = document.getElementById("tabla-usuarios");

    // 1. Cargar el formulario en el modal al abrirlo
    modalEl.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const userId = button.dataset.id || null;
        const modalTitle = modalEl.querySelector('.modal-title');
        const formContainer = modalEl.querySelector('#form-usuario-container');
        const url = userId ? `/usuarios/get-form/${userId}/` : `/usuarios/get-form/`;

        modalTitle.textContent = userId ? 'Editar Usuario' : 'Crear Nuevo Usuario';
        formContainer.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div></div>`;

        fetch(url)
            .then(response => response.text())
            .then(html => {
                formContainer.innerHTML = html;
                initializeFormsetLogic(); // Activa la lógica para el botón "Añadir email"
            })
            .catch(error => {
                formContainer.innerHTML = `<div class="alert alert-danger">Error al cargar el formulario.</div>`;
                console.error('Error fetching form:', error);
            });
    });

    // 2. Guardar el formulario al hacer clic en "Guardar"
    document.getElementById('btn-guardar-usuario').addEventListener('click', function() {
        const form = document.getElementById('form-usuario');
        if (!form) return alert("Error: No se encuentra el formulario para enviar.");
        
        const formData = new FormData(form);
        fetch(form.action, {
            method: "POST",
            headers: { "X-CSRFToken": getCookie("csrftoken"), "X-Requested-With": "XMLHttpRequest" },
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert("Usuario guardado correctamente.");
                location.reload();
            } else if (data.errors) {
                let errorMsg = "Por favor, corrige los siguientes errores:\n\n";
                const errors = JSON.parse(data.errors);
                for (const field in errors) {
                    if (field === 'formset') {
                        errors[field].forEach((formErrors, index) => {
                            for (const emailField in formErrors) { errorMsg += `- Email Adicional ${index + 1}: ${formErrors[emailField][0]}\n`; }
                        });
                    } else { errorMsg += `- ${field}: ${errors[field][0].message || errors[field][0]}\n`; }
                }
                alert(errorMsg);
            } else { alert("Ocurrió un error desconocido."); }
        })
        .catch(error => {
            console.error("Error al enviar el formulario:", error);
            alert("Ocurrió un error inesperado. Revisa la consola.");
        });
    });

    // 3. Acciones en la tabla (Activar/Desactivar, Eliminar)
    tabla.addEventListener('click', function(event) {
        const target = event.target;
        const csrftoken = getCookie("csrftoken");
        
        // --- Cambiar estado (Activar/Desactivar) ---
        if (target.classList.contains('toggle-estado-btn')) {
            const userId = target.dataset.id;
            const badge = target.closest("tr").querySelector(".estado-label");
            fetch(`/usuarios/toggle-estado/${userId}/`, {
                method: "POST",
                headers: { "X-CSRFToken": csrftoken, "X-Requested-With": "XMLHttpRequest" }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    badge.classList.toggle("bg-danger", !data.estado);
                    badge.classList.toggle("bg-success", data.estado);
                    badge.textContent = data.estado ? "Activo" : "Inactivo";
                    target.textContent = data.estado ? "Desactivar" : "Activar";
                } else { alert("No se pudo cambiar el estado."); }
            });
        }

        // --- Eliminar Usuario ---
        if (target.classList.contains('eliminar-usuario')) {
            const userId = target.dataset.id;
            if (confirm("¿Estás seguro de que quieres eliminar este usuario?")) {
                fetch(`/usuarios/eliminar/${userId}/`, {
                    method: "POST",
                    headers: { "X-CSRFToken": csrftoken, "X-Requested-With": "XMLHttpRequest" }
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert("Usuario eliminado.");
                        location.reload();
                    } else { alert(data.error || "No se pudo eliminar."); }
                });
            }
        }
    });
});
</script>
{% endblock %}
