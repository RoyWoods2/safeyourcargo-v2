{% load static %}
<div class="modal fade" id="modal-certificado" tabindex="-1" aria-labelledby="modalCertificadoLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content shadow">

      <style>
        .modal-content {
          font-family: 'Inter', 'Segoe UI', Roboto, Helvetica, sans-serif;
          font-size: 14px;
        }

        .section-container {
          background: #fff;
          border-radius: 8px;
          border: 1px solid #ddd;
          padding: 1.25rem;
          margin-bottom: 1.5rem;
          box-shadow: 0 2px 6px rgba(0,0,0,0.05);
          position: relative;
        }

        .section-container .badge {
          position: absolute;
          top: -0.75rem;
          left: 1rem;
          padding: 0.35em 0.75em;
          font-size: 0.75rem;
          font-weight: 600;
          background-color: #0a8754;
        }

        label {
          font-weight: 600;
          font-size: 13px;
        }

        .form-control, .form-select {
          font-size: 14px;
          padding: 6px 12px;
        }

        .autocomplete-results {
          position: absolute;
          top: 100%;
          left: 0;
          right: 0;
          background: white;
          border: 1px solid #ddd;
          border-top: none;
          border-radius: 0 0 0.25rem 0.25rem;
          max-height: 250px;
          overflow-y: auto;
          z-index: 1056; /* Mayor que el z-index del modal */
          box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .autocomplete-item {
          display: flex;
          align-items: center;
          padding: 0.5rem 0.75rem;
          cursor: pointer;
          border-bottom: 1px solid #eee;
        }

        .autocomplete-item:last-child {
          border-bottom: none;
        }

        .autocomplete-item:hover {
          background-color: #f0f0f0;
        }

        .autocomplete-item img {
          width: 32px;
          height: 32px;
          object-fit: contain;
          margin-right: 10px;
        }
      </style>

      <div class="modal-header">
        <h5 class="modal-title" id="modalCertificadoLabel">Crear Nuevo Certificado</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body">
        <form id="form-certificado" method="post">
          {% csrf_token %}

          <!-- SECCIÓN DE INFORMACIÓN GENERAL -->
          <div class="section-container">
            <span class="badge text-white">INFORMACIÓN GENERAL</span>
            <div class="row mb-3 mt-3">
              <div class="col-md-6">
                <label class="form-label">Póliza</label>
                <input type="text" class="form-control bg-light" value="01930324AA" readonly>
              </div>
              <div class="col-md-6">
                <label class="form-label">Compañía</label>
                <input type="text" class="form-control bg-light" value="SafeYourCargo" readonly>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Cliente</label>
                {{ cert_form.cliente }}
              </div>
              <div class="col-md-3">
                <label class="form-label">Fecha Partida</label>
                {{ cert_form.fecha_partida }}
              </div>
              <div class="col-md-3">
                <label class="form-label">Fecha Llegada</label>
                {{ cert_form.fecha_llegada }}
              </div>
            </div>
          </div>

          <!-- SECCIÓN DE ORIGEN DEL PRODUCTO -->
          <div class="section-container">
            <span class="badge text-white">ORIGEN DEL PRODUCTO</span>
            <div class="row mb-3 mt-3">
              <div class="col-md-6">
                <label class="form-label">País de origen del producto</label>
                <select id="paisOrigen" name="pais_origen" class="form-select">
                  <option value="">Seleccione un país</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Ciudad de origen del producto</label>
                <select id="ciudadOrigen" name="ciudad_origen" class="form-select">
                  <option value="">Seleccione una ciudad</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">País Destino</label>
                <select id="paisDestino" name="pais_destino" class="form-select">
                  <option value="">Seleccione un país</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Ciudad Destino</label>
                <select id="ciudadDestino" name="ciudad_destino" class="form-select">
                  <option value="">Seleccione una ciudad</option>
                </select>
              </div>
            </div>
          </div>

          <!-- SECCIÓN DE EMBARQUE -->
          <div class="section-container">
            <span class="badge text-white">EMBARQUE</span>
            <div class="row mb-3 mt-3">
              <div class="col-md-6">
                <label class="form-label">Modo de Transporte</label>
                {{ metodo_form.modo_transporte }}
              </div>
              <div class="col-md-6">
                <label class="form-label">Tipo de Carga</label>
                {{ metodo_form.tipo_carga }}
              </div>
              <div class="col-md-6">
                <label class="form-label">Cláusula</label>
                {{ metodo_form.clausula }}
              </div>
              <!-- Campos dinámicos de embalaje (se mantienen igual) -->
            </div>
          </div>

          <!-- SECCIÓN DE VALORES Y PRIMA -->
          <div class="section-container">
            <span class="badge text-white">💰 VALORES Y PRIMA</span>
            <div class="row mb-3 mt-3">
              <div class="col-md-6">
                <label class="form-label">Tipo de Mercancía</label>
                {{ mercancia_form.tipo }}
              </div>
              <div class="col-md-3">
                <label class="form-label">Valor FCA (USD)</label>
                {{ mercancia_form.valor_fca }}
              </div>
              <div class="col-md-3">
                <label class="form-label">Valor Flete (USD)</label>
                {{ mercancia_form.valor_flete }}
              </div>
              <div class="col-md-3 mt-3">
                <label class="form-label">Monto Asegurado</label>
                <input type="text" class="form-control" id="montoAsegurado" readonly>
                <input type="hidden" name="monto_asegurado" id="montoAseguradoHidden">
              </div>
              <div class="col-md-12 mt-3">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="togglePrima">
                  <label class="form-check-label" for="togglePrima">Cambiar prima manualmente</label>
                </div>
              </div>
              <div class="col-md-3 mt-2">
                <label class="form-label">Valor Prima (USD)</label>
                <input type="text" id="valorPrimaFormateado" class="form-control" readonly>
                <input type="hidden" id="id_valor_prima" name="valor_prima">
              </div>
            </div>
          </div>

          <!-- SECCIÓN DE DETALLES DEL VIAJE -->
          <div class="section-container">
            <span class="badge text-white">DETALLES DEL VIAJE</span>
            <div class="row mb-3 mt-3">
              
              <div class="col-md-6 position-relative">
                <label class="form-label" id="label_nombre_transporte">Nombre Avión / Navío</label>
                {{ viaje_form.nombre_avion }}
                <div id="transporte-resultados" class="autocomplete-results"></div>
              </div>

              <div class="col-md-6">
                <label class="form-label" id="label_numero_viaje">N° Viaje / Vuelo</label>
                {{ viaje_form.numero_viaje }}
              </div>
              <div class="col-md-6">
                <label class="form-label">País de inicio del viaje</label>
                <select id="vueloOrigenPais" name="vuelo_origen_pais" class="form-select">
                  <option value="">Seleccione un país</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Ciudad de inicio del viaje</label>
                <select id="vueloOrigenCiudad" name="vuelo_origen_ciudad" class="form-select">
                  <option value="">Seleccione una ciudad</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">País de destino del viaje</label>
                <select id="vueloDestinoPais" name="vuelo_destino_pais" class="form-select">
                  <option value="">Seleccione un país</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label"> Ciudad de destino del viaje</label>
                <select id="vueloDestinoCiudad" name="vuelo_destino_ciudad" class="form-select">
                  <option value="">Seleccione una ciudad</option>
                </select>
              </div>
              <div class="col-md-6" id="grupo_aeropuerto_origen">
                <label class="form-label" id="label_punto_origen">Aeropuerto / Puerto Origen</label>
                {{ viaje_form.aeropuerto_origen }}
              </div>
              <div class="col-md-6" id="grupo_aeropuerto_destino">
                <label class="form-label" id="label_punto_destino">Aeropuerto / Puerto Destino</label>
                {{ viaje_form.aeropuerto_destino }}
              </div>
              <div class="col-12 mt-2">
                <label class="form-label">Descripción</label>
                {{ viaje_form.descripcion_carga }}
              </div>
            </div>
          </div>

          <!-- SECCIONES RESTANTES (NOTAS, ENVÍO) -->
          <div class="section-container">
            <span class="badge text-white">NOTAS Y NÚMEROS</span>
            <div class="row mb-3 mt-3">
              <div class="col-md-4"><label class="form-label">Referencia</label>{{ notas_form.referencia }}</div>
              <div class="col-md-4"><label class="form-label">Guía de Carga</label>{{ notas_form.guia_carga }}</div>
              <div class="col-md-4"><label class="form-label">N° Factura</label>{{ notas_form.numero_factura }}</div>
              <div class="col-12 mt-2"><label class="form-label">Notas</label>{{ notas_form.notas }}</div>
            </div>
          </div>
          
          <!-- SECCIÓN DE OPCIONES DE ENVÍO (CORREGIDA Y MEJORADA) -->
          <div class="section-container">
            <span class="badge text-white">OPCIONES DE ENVÍO</span>
            <div class="form-check mb-3 mt-3">
              <input class="form-check-input" type="checkbox" id="toggleOtrosEmails">
              <label class="form-check-label" for="toggleOtrosEmails">
                Añadir destinatarios de correo adicionales para este envío
              </label>
            </div>
            <div id="otrosEmailsContainer" style="display: none;">
              <!-- Reemplazamos el input por un textarea para mejor visualización -->
              <textarea name="otros_emails_copia" id="id_otros_emails_copia" class="form-control" rows="3" placeholder="email1@dominio.com, email2@dominio.com, ..."></textarea>
              <small class="form-text text-muted mt-1 d-block">
                Separa múltiples correos con una coma (,). Estos se sumarán a los que ya tengas configurados en tu perfil.
              </small>
            </div>
          </div>

        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="submit" class="btn btn-primary" form="form-certificado">Guardar</button>
      </div>
    </div>
  </div>
</div>

<div id="spinner-overlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(255,255,255,0.85); z-index:9999; justify-content:center; align-items:center; flex-direction:column;">
  <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
    <span class="visually-hidden">Cargando...</span>
  </div>
  <p class="mt-3 text-primary fw-bold">Generando certificado y factura electrónica...</p>
</div>

<!-- ✅ SCRIPT COMPLETO Y CORREGIDO -->
<script>
// =================================================================================
// SCRIPT UNIFICADO PARA MODAL DE CREACIÓN DE CERTIFICADO
// =================================================================================
document.addEventListener('DOMContentLoaded', () => {

    // --- SECCIÓN 1: FUNCIONES AUXILIARES ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            for (let cookie of document.cookie.split(';')) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function calcularMontoAsegurado() {
        const fca = parseFloat(document.getElementById("id_valor_fca").value.replace(',', '.')) || 0;
        const flete = parseFloat(document.getElementById("id_valor_flete").value.replace(',', '.')) || 0;
        const asegurado = (fca + flete) * 1.10;

        document.getElementById("montoAsegurado").value = asegurado.toFixed(2);
        document.getElementById("montoAseguradoHidden").value = asegurado.toFixed(2);

        const togglePrima = document.getElementById("togglePrima");
        if (togglePrima && !togglePrima.checked) {
            const primaHiddenInput = document.getElementById("id_valor_prima");
            const primaVisualInput = document.getElementById("valorPrimaFormateado");
            const clienteSelect = document.getElementById("id_cliente");
            const tipoCargaSelect = document.getElementById("id_tipo_carga");

            if (clienteSelect && clienteSelect.selectedIndex > 0 && tipoCargaSelect) {
                const selected = clienteSelect.options[clienteSelect.selectedIndex];
                const tipoCarga = tipoCargaSelect.value;
                let tasa = 0.15;
                let minimo = 20.0;

                if (tipoCarga === 'PolizaCongelada') {
                    tasa = parseFloat(selected.dataset.tasaCongelada);
                    minimo = parseFloat(selected.dataset.minimoCongelado);
                } else {
                    tasa = parseFloat(selected.dataset.tasa);
                    minimo = parseFloat(selected.dataset.minimo);
                }

                const primaCalculada = Math.max(asegurado * (tasa / 100), minimo);
                primaHiddenInput.value = primaCalculada.toFixed(2);
                primaVisualInput.value = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD'
                }).format(primaCalculada);
            }
        }
    }

    const handleManualPrimaInput = function() {
        const primaHiddenInput = document.getElementById("id_valor_prima");
        let rawValue = this.value.replace(/[^0-9.,]/g, '').replace(',', '.');
        primaHiddenInput.value = parseFloat(rawValue || '0').toFixed(2);
    };

    // --- SECCIÓN 2: LÓGICA DE EVENTOS ---

    // --- LÓGICA DE CÁLCULO DE PRIMAS ---
    const togglePrima = document.getElementById("togglePrima");
    const primaVisualInput = document.getElementById("valorPrimaFormateado");
    
    if (togglePrima) {
        primaVisualInput.readOnly = !togglePrima.checked;
        togglePrima.addEventListener('change', function() {
            primaVisualInput.readOnly = !this.checked;
            if (this.checked) {
                primaVisualInput.value = parseFloat(document.getElementById("id_valor_prima").value || '0').toFixed(2);
                primaVisualInput.focus();
                primaVisualInput.addEventListener('input', handleManualPrimaInput);
            } else {
                primaVisualInput.removeEventListener('input', handleManualPrimaInput);
                calcularMontoAsegurado();
            }
        });
    }
    
    const camposParaCalculo = ["id_valor_fca", "id_valor_flete", "id_cliente", "id_tipo_carga"];
    camposParaCalculo.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', calcularMontoAsegurado);
    });
    
    // --- LÓGICA DE AUTOCOMPLETADO DE TRANSPORTE (AÉREO Y MARÍTIMO) ---
    const inputTransporte = document.getElementById('id_nombre_transporte');
    const resultadosDiv = document.getElementById('transporte-resultados');
    const modoTransporteSelect = document.getElementById('modoTransporte');

    if (inputTransporte && resultadosDiv && modoTransporteSelect) {
        inputTransporte.addEventListener('keyup', async (e) => {
            const query = e.target.value;
            const modo = modoTransporteSelect.value;
            let url = '';

            if (query.length < 2) {
                resultadosDiv.innerHTML = '';
                resultadosDiv.style.display = 'none';
                return;
            }

            if (modo === 'Aereo') {
                url = `/buscar-aerolineas/?query=${query}`;
            } else if (modo === 'Maritimo') {
                url = `/buscar-navios/?query=${query}`;
            } else {
                resultadosDiv.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(url);
                const data = await response.json();
                resultadosDiv.innerHTML = '';

                if (data.results && data.results.length > 0) {
                    resultadosDiv.style.display = 'block';
                    data.results.forEach(item => {
                        const divItem = document.createElement('div');
                        divItem.classList.add('autocomplete-item');
                        
                        let logoHtml = '';
                        if (modo === 'Aereo' && item.iata) {
                            logoHtml = `<img src="https://images.daisycon.io/airline/?iata=${item.iata}" alt="${item.name}" onerror="this.src='{% static "img/avion-default.png" %}'">`;
                        } else if (modo === 'Maritimo') {
                            logoHtml = `<img src="{% static 'img/barco.png' %}" alt="Navío">`;
                        }

                        divItem.innerHTML = `${logoHtml} <span>${item.name}</span>`;
                        
                        divItem.addEventListener('click', () => {
                            inputTransporte.value = item.name;
                            resultadosDiv.innerHTML = '';
                            resultadosDiv.style.display = 'none';
                        });
                        resultadosDiv.appendChild(divItem);
                    });
                } else {
                    resultadosDiv.style.display = 'none';
                }
            } catch (error) {
                console.error("Error en autocompletado:", error);
                resultadosDiv.style.display = 'none';
            }
        });

        document.addEventListener('click', (e) => {
            if (e.target !== inputTransporte && e.target.closest('.autocomplete-results') !== resultadosDiv) {
                resultadosDiv.style.display = 'none';
            }
        });
    }

    // --- LÓGICA DE ENVÍO DEL FORMULARIO ---
    const form = document.getElementById("form-certificado");
    const spinner = document.getElementById("spinner-overlay");

    if (form && spinner) {
        form.addEventListener("submit", function(e) {
            e.preventDefault();
            spinner.style.display = "flex";
            const formData = new FormData(form);

            fetch("{% url 'crear_certificado' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                spinner.style.display = "none";
                if (data.success) {
                    Swal.fire({
                        icon: "success",
                        title: "Certificado creado",
                        text: "El certificado y la factura han sido procesados.",
                        confirmButtonText: "Ver listado"
                    }).then(() => location.reload());
                } else if (data.errors) {
                    let mensaje = "Por favor, corrige los siguientes errores:\n\n";
                    for (const formName in data.errors) {
                        for (const fieldName in data.errors[formName]) {
                            mensaje += `- ${fieldName.replace(/_/g, ' ')}: ${data.errors[formName][fieldName].join(", ")}\n`;
                        }
                    }
                    Swal.fire({
                        icon: "error",
                        title: "Errores en el formulario",
                        html: `<pre style="text-align: left; white-space: pre-wrap;">${mensaje}</pre>`
                    });
                } else {
                    Swal.fire({
                        icon: "error",
                        title: "Error desconocido",
                        text: "No se pudo generar el certificado."
                    });
                }
            })
            .catch(error => {
                spinner.style.display = "none";
                Swal.fire({
                    icon: "error",
                    title: "Error de red",
                    text: error.message || "No se pudo conectar al servidor."
                });
            });
        });
    }
    
    // ✅ --- LÓGICA CORREGIDA PARA MOSTRAR/OCULTAR EMAILS ADICIONALES ---
    const toggleOtrosEmails = document.getElementById('toggleOtrosEmails');
    const otrosEmailsContainer = document.getElementById('otrosEmailsContainer');

    if (toggleOtrosEmails && otrosEmailsContainer) {
        toggleOtrosEmails.addEventListener('change', function() {
            if (this.checked) {
                otrosEmailsContainer.style.display = 'block';
            } else {
                otrosEmailsContainer.style.display = 'none';
            }
        });
    }
    
    // --- INICIALIZACIÓN ---
    calcularMontoAsegurado(); // Calcular al cargar por si hay datos precargados
});
</script>


<script src="{% static 'js/formulario_viaje.js' %}"></script>
