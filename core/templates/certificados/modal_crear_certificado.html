{% load static %}
<div class="modal fade" id="modal-certificado" tabindex="-1" aria-labelledby="modalCertificadoLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content shadow">

      <style>
        .modal-content {
          font-family: 'Inter', 'Segoe UI', Roboto, Helvetica, sans-serif;
          font-size: 14px;
        }

        .section-container {
          background: #fff;
          border-radius: 8px;
          border: 1px solid #ddd;
          padding: 1.25rem;
          margin-bottom: 1.5rem;
          box-shadow: 0 2px 6px rgba(0,0,0,0.05);
          position: relative;
        }

        .section-container .badge {
          position: absolute;
          top: -0.75rem;
          left: 1rem;
          padding: 0.35em 0.75em;
          font-size: 0.75rem;
          font-weight: 600;
          background-color: #0a8754;
        }

        label {
          font-weight: 600;
          font-size: 13px;
        }

        .form-control, .form-select {
          font-size: 14px;
          padding: 6px 12px;
        }

        .autocomplete-results {
          position: absolute;
          top: 100%;
          left: 0;
          right: 0;
          background: white;

          max-height: 250px;
          overflow-y: auto;
          z-index: 1056; /* Mayor que el z-index del modal */
          box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .autocomplete-item {
          display: flex;
          align-items: center;
          padding: 0.5rem 0.75rem;
          cursor: pointer;
          border-bottom: 1px solid #eee;
        }

        .autocomplete-item:last-child {
          border-bottom: none;
        }

        .autocomplete-item:hover {
          background-color: #f0f0f0;
        }

        .autocomplete-item img {
          width: 32px;
          height: 32px;
          object-fit: contain;
          margin-right: 10px;
        }
      </style>

      <div class="modal-header">
        <h5 class="modal-title" id="modalCertificadoLabel">Crear Nuevo Certificado</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body">
        <form id="form-certificado" method="post">
          {% csrf_token %}

          <!-- SECCI칍N DE INFORMACI칍N GENERAL -->
          <div class="section-container">
            <span class="badge text-white">INFORMACI칍N GENERAL</span>
            <div class="row mb-3 mt-3">
              <div class="col-md-6">
                <label class="form-label">P칩liza</label>
                <input type="text" class="form-control bg-light" value="01930324AA" readonly>
              </div>
              <div class="col-md-6">
                <label class="form-label">Compa침칤a</label>
                <input type="text" class="form-control bg-light" value="SafeYourCargo" readonly>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Cliente</label>
                {{ cert_form.cliente }}
              </div>
              <div class="col-md-3">
                <label class="form-label">Fecha Partida</label>
                {{ cert_form.fecha_partida }}
              </div>
              <div class="col-md-3">
                <label class="form-label">Fecha Llegada</label>
                {{ cert_form.fecha_llegada }}
              </div>
            </div>
          </div>

          <!-- SECCI칍N DE ORIGEN DEL PRODUCTO -->
          <div class="section-container">
            <span class="badge text-white">ORIGEN DEL PRODUCTO</span>
            <div class="row mb-3 mt-3">
              <div class="col-md-6">
                <label class="form-label">Pa칤s de origen del producto</label>
                <select id="paisOrigen" name="pais_origen" class="form-select">
                  <option value="">Seleccione un pa칤s</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Ciudad de origen del producto</label>
                <select id="ciudadOrigen" name="ciudad_origen" class="form-select">
                  <option value="">Seleccione una ciudad</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Pa칤s Destino</label>
                <select id="paisDestino" name="pais_destino" class="form-select">
                  <option value="">Seleccione un pa칤s</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Ciudad Destino</label>
                <select id="ciudadDestino" name="ciudad_destino" class="form-select">
                  <option value="">Seleccione una ciudad</option>
                </select>
              </div>
            </div>
          </div>


<!-- SECCI칍N DE EMBARQUE -->
<div class="section-container">
  <span class="badge text-white">EMBARQUE</span>

  <div class="row mb-3 mt-3 g-3">
    <!-- Campos principales -->
    <div class="col-md-4">
      {{ metodo_form.modo_transporte.label_tag }}
      {{ metodo_form.modo_transporte }}
    </div>
    <div class="col-md-4">
      {{ metodo_form.tipo_carga.label_tag }}
      {{ metodo_form.tipo_carga }}
    </div>
    <div class="col-md-4">
      {{ metodo_form.clausula.label_tag }}
      {{ metodo_form.clausula }}
    </div>

    <!-- Campos din치micos seg칰n el tipo de transporte -->
    <div id="campos-embarque-dinamicos" class="col-12">
      <div class="row g-3">

        <!-- A칄REO -->
        <div id="grupo_embalaje_aereo" class="col-md-6 d-none">
          {{ metodo_form.tipo_embalaje_aereo.label_tag }}
          {{ metodo_form.tipo_embalaje_aereo }}
        </div>
        <div id="grupo_otro_embalaje_aereo" class="col-md-6 d-none">
          {{ metodo_form.otro_embalaje_aereo.label_tag }}
          {{ metodo_form.otro_embalaje_aereo }}
        </div>

        <!-- MAR칈TIMO -->
        <div id="grupo_embalaje_maritimo" class="col-md-6 d-none">
          {{ metodo_form.embalaje_maritimo.label_tag }}
          {{ metodo_form.embalaje_maritimo }}
        </div>
        <div id="grupo_tipo_container_maritimo" class="col-md-6 d-none">
          {{ metodo_form.tipo_container_maritimo.label_tag }}
          {{ metodo_form.tipo_container_maritimo }}
        </div>
        <div id="grupo_tipo_embalaje_lcl" class="col-md-6 d-none">
          {{ metodo_form.tipo_embalaje_lcl.label_tag }}
          {{ metodo_form.tipo_embalaje_lcl }}
        </div>
        <div id="grupo_otro_embalaje_lcl" class="col-md-6 d-none">
          {{ metodo_form.otro_embalaje_lcl.label_tag }}
          {{ metodo_form.otro_embalaje_lcl }}
        </div>

        <!-- TERRESTRE -->
        <div id="grupo_embalaje_terrestre" class="col-md-6 d-none">
          {{ metodo_form.tipo_embalaje_terrestre.label_tag }}
          {{ metodo_form.tipo_embalaje_terrestre }}
        </div>
        <div id="grupo_otro_embalaje_terrestre" class="col-md-6 d-none">
          {{ metodo_form.otro_embalaje_terrestre.label_tag }}
          {{ metodo_form.otro_embalaje_terrestre }}
        </div>

      </div>
    </div>
  </div>
</div>


          <!-- SECCI칍N DE VALORES Y PRIMA -->
          <div class="section-container">
            <span class="badge text-white">游눯 VALORES Y PRIMA</span>
            <div class="row mb-3 mt-3">
              <div class="col-md-6">
                <label class="form-label">Tipo de Mercanc칤a</label>
                {{ mercancia_form.tipo }}
              </div>
              <div class="col-md-3">
                <label class="form-label">Valor FCA (USD)</label>
                {{ mercancia_form.valor_fca }}
              </div>
              <div class="col-md-3">
                <label class="form-label">Valor Flete (USD)</label>
                {{ mercancia_form.valor_flete }}
              </div>
              <div class="col-md-3 mt-3">
                <label class="form-label">Monto Asegurado</label>
                <input type="text" class="form-control" id="montoAsegurado" readonly>
                <input type="hidden" name="monto_asegurado" id="montoAseguradoHidden">
              </div>
              <div class="col-md-12 mt-3">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="togglePrima">
                  <label class="form-check-label" for="togglePrima">Cambiar prima manualmente</label>
                </div>
              </div>
              <div class="col-md-3 mt-2">
                <label class="form-label">Valor Prima (USD)</label>
                <input type="text" id="valorPrimaFormateado" class="form-control" readonly>
                <input type="hidden" id="id_valor_prima" name="valor_prima">
              </div>
            </div>
          </div>

          <!-- SECCI칍N DE DETALLES DEL VIAJE -->
          <div class="section-container">
            <span class="badge text-white">DETALLES DEL VIAJE</span>
            <div class="row mb-3 mt-3">
              
              <div class="col-md-6 position-relative">
                <label class="form-label" id="label_nombre_transporte">Nombre Avi칩n / Nav칤o</label>
                {{ viaje_form.nombre_avion}}
                <div id="transporte-resultados" class="autocomplete-results"></div>
              </div>

              <div class="col-md-6">
                <label class="form-label" id="label_numero_viaje">N춿 Viaje / Vuelo</label>
                {{ viaje_form.numero_viaje }}
              </div>
              <div class="col-md-6">
                <label class="form-label">Pa칤s de inicio del viaje</label>
                <select id="vueloOrigenPais" name="vuelo_origen_pais" class="form-select">
                  <option value="">Seleccione un pa칤s</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Ciudad de inicio del viaje</label>
                <select id="vueloOrigenCiudad" name="vuelo_origen_ciudad" class="form-select">
                  <option value="">Seleccione una ciudad</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Pa칤s de destino del viaje</label>
                <select id="vueloDestinoPais" name="vuelo_destino_pais" class="form-select">
                  <option value="">Seleccione un pa칤s</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label"> Ciudad de destino del viaje</label>
                <select id="vueloDestinoCiudad" name="vuelo_destino_ciudad" class="form-select">
                  <option value="">Seleccione una ciudad</option>
                </select>
              </div>
              <div class="col-md-6" id="grupo_aeropuerto_origen">
                <label class="form-label" id="label_punto_origen">Aeropuerto / Puerto Origen</label>
                {{ viaje_form.aeropuerto_origen }}
              </div>
              <div class="col-md-6" id="grupo_aeropuerto_destino">
                <label class="form-label" id="label_punto_destino">Aeropuerto / Puerto Destino</label>
                {{ viaje_form.aeropuerto_destino }}
              </div>
              <div class="col-12 mt-2">
                <label class="form-label">Descripci칩n</label>
                {{ viaje_form.descripcion_carga }}
              </div>
            </div>
          </div>

          <!-- SECCIONES RESTANTES (NOTAS, ENV칈O) -->
          <div class="section-container">
            <span class="badge text-white">NOTAS Y N칔MEROS</span>
            <div class="row mb-3 mt-3">
              <div class="col-md-4"><label class="form-label">Referencia</label>{{ notas_form.referencia }}</div>
              <div class="col-md-4"><label class="form-label">Gu칤a de Carga</label>{{ notas_form.guia_carga }}</div>
              <div class="col-md-4"><label class="form-label">N춿 Factura</label>{{ notas_form.numero_factura }}</div>
              <div class="col-12 mt-2"><label class="form-label">Notas</label>{{ notas_form.notas }}</div>
            </div>
          </div>
          
          <!-- SECCI칍N DE OPCIONES DE ENV칈O (CORREGIDA Y MEJORADA) -->
          <div class="section-container">
            <span class="badge text-white">OPCIONES DE ENV칈O</span>
            <div class="form-check mb-3 mt-3">
              <input class="form-check-input" type="checkbox" id="toggleOtrosEmails">
              <label class="form-check-label" for="toggleOtrosEmails">
                A침adir destinatarios de correo adicionales para este env칤o
              </label>
            </div>
            <div id="otrosEmailsContainer" style="display: none;">
              <!-- Reemplazamos el input por un textarea para mejor visualizaci칩n -->
              <textarea name="otros_emails_copia" id="id_otros_emails_copia" class="form-control" rows="3" placeholder="email1@dominio.com, email2@dominio.com, ..."></textarea>
              <small class="form-text text-muted mt-1 d-block">
                Separa m칰ltiples correos con una coma (,). Estos se sumar치n a los que ya tengas configurados en tu perfil.
              </small>
            </div>
          </div>

        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="submit" class="btn btn-primary" form="form-certificado">Guardar</button>
      </div>
    </div>
  </div>
</div>

<div id="spinner-overlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(255,255,255,0.85); z-index:9999; justify-content:center; align-items:center; flex-direction:column;">
  <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
    <span class="visually-hidden">Cargando...</span>
  </div>
  <p class="mt-3 text-primary fw-bold">Generando certificado y factura electr칩nica...</p>
</div>





<script src="{% static 'js/formulario_viaje.js' %}"></script>
